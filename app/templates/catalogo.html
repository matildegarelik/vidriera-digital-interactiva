{% extends 'layout.html' %}

{% block css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/catalogo.css') }}">

{% endblock %}

{% block content %}
<div class="filtros">
  <ul class="nav nav-tabs" id="tabsCatalogo" role="tablist">
    {% for categoria in categorias %}
    <li class="nav-item" role="presentation">
      <button class="nav-link {%if loop.first%} active {%endif%}" id="tab{{categoria.category_id}}-tab" data-bs-toggle="tab" data-bs-target="#tab{{categoria.category_id}}" type="button" role="tab">Categoría {{categoria.category_id}}</button>
    </li>
    {% endfor %}
  </ul>

</div>

<div class="tab-content px-5" id="tabsCatalogoContent">
    {% for categoria in categorias %}
    <div class="tab-pane fade show {% if loop.first %} active {% endif %}" id="tab{{categoria.category_id}}" role="tabpanel">
        <div class="tab-content px-5" id="tabsCategoriaContent">
            {% for modelo in categoria.modelos %}
            <div class="tab-pane fade show {% if loop.first %} active {% endif %}" id="subtab{{modelo.product_id}}" role="tabpanel">
                
                <div class="producto">
                    <div class="imagen_producto">
                        <img id="imagen_principal"
                          src="{{ modelo.path_to_img_front_flattened if modelo.path_to_img_front_flattened else url_for('static', filename='images/placeholder.svg') }}"
                          alt="Imagen {{ modelo.name }}">
                    </div>
                    <div class = "bloque_flecha_descripcion">
                        
                        <div class="descripcion">
                            <h2 id="nombre_prod">{{modelo.name}}</h2>
                            <h3 id="precio_prod">${{modelo.product.price}}</h3>
                            <p id="descripcion_prod">{{modelo.description}}</p>
                        </div>

                        <div class="mt-3">
                          <a class="btn btn-primary"
                            href="{{ url_for('main.probar_lente', model_id=modelo.model_id) }}">
                            Probar
                          </a>
                        </div>

                        
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="slider-container">
            <button class="slider-arrow left" id="arrowLeft" style="display:none">&#10094;</button>

            <div class="tabsCategoria-wrapper">
                <ul class="nav nav-tabs tabsCategoria py-3" role="tablist">
                {% for modelo in categoria.modelos %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link  {% if loop.first %} active {% endif %}" id="subtab{{modelo.product_id}}-tab" data-bs-toggle="tab" data-bs-target="#subtab{{modelo.product_id}}" type="button" role="tab">
                      <img src="{{ modelo.path_to_img_front_flattened if modelo.path_to_img_front_flattened else url_for('static', filename='images/placeholder.svg') }}"
                        class="card-img-top" style="height: 60px;" alt="Imagen {{ modelo.name }}">
                    </button>
                </li>
                {% endfor %}
                
                </ul>
            </div>

            <button class="slider-arrow right" id="arrowRight" style="display: none;">&#10095;</button>
        </div>

    
    </div>
    {% endfor %}
</div>


<div class="position-fixed bottom-0 start-0 w-100 qrContainer d-flex align-items-center justify-content-between px-3 py-4">
    <p class="mb-0">Escaneá el QR para navegar por el catálogo y probarte los modelos</p>
    <img src="{{ url_for('main.qr') }}" alt="QR dinámico" style="height: 200px;">
</div>



<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
  // Helpers
  function centerInWrapper(tabBtn) {
    const slider = tabBtn.closest('.slider-container');
    if (!slider) return;
    const wrapper = slider.querySelector('.tabsCategoria-wrapper');
    const wRect = wrapper.getBoundingClientRect();
    const eRect = tabBtn.getBoundingClientRect();
    const delta = (eRect.left + eRect.width / 2) - (wRect.left + wRect.width / 2);
    wrapper.scrollBy({ left: delta, behavior: 'smooth' });
  }

  function getActiveCategoryTabBtn() {
    return document.querySelector('#tabsCatalogo .nav-link.active');
  }

  function getActiveCategoryPane() {
    const activeCatBtn = getActiveCategoryTabBtn();
    if (!activeCatBtn) return null;
    const targetSel = activeCatBtn.getAttribute('data-bs-target') || activeCatBtn.dataset.bsTarget;
    return document.querySelector(targetSel);
  }

  function getActiveProductBtn() {
    return document.querySelector('.tabsCategoria .nav-link.active');
  }

  function clickTab(btn) { if (btn) btn.click(); }

  // Auto-advance timer
  let idleTimer = null;
  function resetInactivityTimer() {
    if (idleTimer) clearTimeout(idleTimer);
    idleTimer = setTimeout(autoAdvance, 60_000); // 1 minuto
  }

  function autoAdvance() {
    const catTabs = Array.from(document.querySelectorAll('#tabsCatalogo .nav-link'));
    const activeCatBtn = getActiveCategoryTabBtn();
    const catIdx = Math.max(0, catTabs.indexOf(activeCatBtn));

    const activePane = getActiveCategoryPane();
    if (!activePane) return resetInactivityTimer();

    const prodBtns = Array.from(activePane.querySelectorAll('.tabsCategoria .nav-link'));
    const activeProdBtn = getActiveProductBtn();
    const prodIdx = Math.max(0, prodBtns.indexOf(activeProdBtn));

    // Siguiente modelo en la misma categoría, o pasar de categoría si termina
    if (prodIdx < prodBtns.length - 1) {
      clickTab(prodBtns[prodIdx + 1]);
    } else {
      const nextCatIdx = (catIdx + 1) % catTabs.length;
      clickTab(catTabs[nextCatIdx]); // activa categoría
      // activar primer modelo de esa categoría
      const nextPane = document.querySelector(catTabs[nextCatIdx].getAttribute('data-bs-target') || catTabs[nextCatIdx].dataset.bsTarget);
      const nextProdBtns = Array.from(nextPane.querySelectorAll('.tabsCategoria .nav-link'));
      if (nextProdBtns.length) clickTab(nextProdBtns[0]);
    }
    resetInactivityTimer();
  }

  // Mostrar flechas del slider (opcional)
  const wrapper = document.querySelector('.tabsCategoria-wrapper');
  const btnLeft = document.getElementById('arrowLeft');
  const btnRight = document.getElementById('arrowRight');
  if (wrapper && btnLeft && btnRight) {
    //btnLeft.style.display = 'block';
    //btnRight.style.display = 'block';
    btnLeft.addEventListener('click', () => wrapper.scrollBy({ left: -200, behavior: 'smooth' }));
    btnRight.addEventListener('click', () => wrapper.scrollBy({ left:  200, behavior: 'smooth' }));
  }

  // Centrar siempre que se muestre un subtab (modelo) y resetear timer
  document.addEventListener('shown.bs.tab', (ev) => {
    const btn = ev.target; // botón de tab activado
    if (btn.id && btn.id.startsWith('subtab') && btn.classList.contains('nav-link')) {
      centerInWrapper(btn);
      resetInactivityTimer();
    }
    // Si se cambió la categoría, centrar el modelo activo de esa categoría
    if (btn.id && btn.id.startsWith('tab') && btn.classList.contains('nav-link')) {
      const pane = document.querySelector(btn.getAttribute('data-bs-target') || btn.dataset.bsTarget);
      const prodActive = pane?.querySelector('.tabsCategoria .nav-link.active') || pane?.querySelector('.tabsCategoria .nav-link');
      if (prodActive) {
        // asegurar que haya un modelo activo y centrar
        if (!prodActive.classList.contains('active')) clickTab(prodActive);
        centerInWrapper(prodActive);
        resetInactivityTimer();
      }
    }
  });
  //------------------ Para control ------------------//
  function moveNextProduct() {
    const activePane = getActiveCategoryPane();
    if (!activePane) return;

    const prodBtns = Array.from(activePane.querySelectorAll('.tabsCategoria .nav-link'));
    if (!prodBtns.length) return;

    const activeInPane = activePane.querySelector('.tabsCategoria .nav-link.active') || prodBtns[0];
    const idx = prodBtns.indexOf(activeInPane);
    const nextIdx = (idx + 1) % prodBtns.length;

    clickTab(prodBtns[nextIdx]);
  }

  function movePrevProduct() {
    const activePane = getActiveCategoryPane();
    if (!activePane) return;

    const prodBtns = Array.from(activePane.querySelectorAll('.tabsCategoria .nav-link'));
    if (!prodBtns.length) return;

    const activeInPane = activePane.querySelector('.tabsCategoria .nav-link.active') || prodBtns[0];
    const idx = prodBtns.indexOf(activeInPane);
    const prevIdx = (idx - 1 + prodBtns.length) % prodBtns.length;

    clickTab(prodBtns[prevIdx]);
  }

  function moveNextCategory() {
    const catBtns = Array.from(document.querySelectorAll('#tabsCatalogo .nav-link'));
    if (!catBtns.length) return;

    const activeCatBtn = getActiveCategoryTabBtn() || catBtns[0];
    const idx = catBtns.indexOf(activeCatBtn);
    const nextIdx = (idx + 1) % catBtns.length;

    clickTab(catBtns[nextIdx]); // tu handler shown.bs.tab activa/centra el primer modelo
  }

  function movePrevCategory() {
    const catBtns = Array.from(document.querySelectorAll('#tabsCatalogo .nav-link'));
    if (!catBtns.length) return;

    const activeCatBtn = getActiveCategoryTabBtn() || catBtns[0];
    const idx = catBtns.indexOf(activeCatBtn);
    const prevIdx = (idx - 1 + catBtns.length) % catBtns.length;

    clickTab(catBtns[prevIdx]);
  }
  //------------------ Eventos ------------------//
  // Socket: seleccionar y centrar al llegar evento, y resetear timer
  const socket = io();

  // Inicializar: centrar el activo al cargar y arrancar timer
  window.addEventListener('load', () => {
    const initial = getActiveProductBtn();
    if (initial) centerInWrapper(initial);
    resetInactivityTimer();
  });
  socket.on("actualizar_producto", data => {
      console.log("Mover catalogo:", data);
      if (data.direccion === "izquierda") {
        movePrevProduct();
      } else if (data.direccion === "derecha") {
        moveNextProduct();
      }
    });
    socket.on("actualizar_categoria", data => {
      console.log("Mover categoria:", data);
      if (data.direccion === "izquierda") {
        movePrevCategory();
      } else if (data.direccion === "derecha") {
        moveNextCategory();
      }
    });
      
</script>



{% endblock %}