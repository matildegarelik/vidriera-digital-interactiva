{% extends 'layout.html' %}

{% block css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/home_admin.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        .mover {
            cursor: move; /* O 'grab' */
        }
        /* Estilo del item fantasma mientras se arrastra */
        .sortable-ghost {
            opacity: 0.4;
            background: #f0f0f0;
            border: 1px dashed #ccc;
        }
    </style>
{% endblock %}

{% block content %}
{% with messages = get_flashed_messages() %}
{% if messages %}
    <div class="alert alert-info">{{ messages[0] }}</div>
{% endif %}
{% endwith %}
<div class="container">
      <div class="barra_lateral">
        <h1 class="bienvenido">Bienvenido!</h1>
        <a href="/logout" class="btn btn-outline-primary" style="float:right">Logout</a>

        <div class="categorias_admin">
            <h5 class="mb-3">Categorías</h5>
            <div class="list-group categoria-list">
                <button class="list-group-item list-group-item-action active" data-category-id="all">
                    Todos los modelos
                    <span class="badge bg-primary rounded-pill">{{ models|length }}</span>
                </button>
                {% for categoria in categorias %}
                <button class="list-group-item list-group-item-action" data-category-id="{{ categoria.category_id }}">
                    Categoría {{ categoria.category_id }}
                    <span class="badge bg-secondary rounded-pill">{{ categoria.modelos|length }}</span>
                </button>
                {% endfor %}
            </div>
        </div>
    </div>


     <div class="sector_modelos">
        <h3>Modelos de lentes</h3>
        <div class="container_modelos" id="sortable-models-container">
            {% for lente in models%}
            <div class="item_cuadricula" data-model-id="{{ lente.model_id }}" data-categories="{% if lente.product and lente.product.categorias %}{% for cat in lente.product.categorias %}{{ cat.category_id }}{% if not loop.last %},{% endif %}{% endfor %}{% endif %}">
                <div class="info_lente_cuadricula">
                    <p class="nombre_cuadricula">{{lente.name}}</p>
                    <button class="btn btn-sm btn-outline-info toggle-visible" data-id="{{ lente.model_id }}" title="Visibilidad">
                            {% if lente.visible %}
                                <i class="fas fa-eye"></i>
                            {% else %}
                                <i class="fas fa-eye-slash"></i>
                            {% endif %}
                    </button>
                </div>
                <div class="img_botones">
                    <img class="img_cuadricula" src="{{lente.path_to_img_front if lente.path_to_img_front else url_for('static', filename='images/placeholder.svg') }}">
                    <div class="botones_atras">
                        <a href="{{ url_for('main.lente_detalle', lente_id=lente.model_id) }}" class="btn btn-sm btn-outline-secondary" title="Editar">
                        <i class="btn_accion editar">Editar</i>
                        </a>
                        <button class="btn btn-sm btn-outline-primary mover" title="Mover">
                            <i class="fas fa-arrows-alt"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-lente" data-id="{{ lente.model_id }}" title="Eliminar">
                        <i>Eliminar</i>
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
            <div class="item_cuadricula agregar_item">
                <a href="{{ url_for('main.agregar_lente') }}" class="btn btn-primary" style="float:right">+</a>
            </div>
        </div>
    </div>

</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<script>
    // --- Lógica de filtrado por categoría ---
    document.querySelectorAll('.categoria-list .list-group-item').forEach(button => {
        button.addEventListener('click', () => {
            const categoryId = button.dataset.categoryId;

            // Actualizar estado activo
            document.querySelectorAll('.categoria-list .list-group-item').forEach(b => {
                b.classList.remove('active');
            });
            button.classList.add('active');

            // Filtrar modelos
            const allModels = document.querySelectorAll('.item_cuadricula:not(.agregar_item)');

            if (categoryId === 'all') {
                // Mostrar todos
                allModels.forEach(model => {
                    model.style.display = '';
                });
            } else {
                // Filtrar por categoría
                allModels.forEach(model => {
                    const categories = model.dataset.categories;
                    if (categories && categories.split(',').includes(categoryId)) {
                        model.style.display = '';
                    } else {
                        model.style.display = 'none';
                    }
                });
            }
        });
    });

    // --- Lógica existente de toggle-visible ---
    document.querySelectorAll('.toggle-visible').forEach(button => {
        button.addEventListener('click', () => {
            const id = button.dataset.id;
            fetch(`/toggle_visible/${id}`, {
                method: 'POST'
            })
            .then(res => res.json())
            .then(data => {
                const icon = button.querySelector('i');
                icon.className = data.new_visible ? 'fas fa-eye' : 'fas fa-eye-slash';
            });
        });
    });

    // --- Lógica existente de delete-lente (con corrección) ---
    document.querySelectorAll('.delete-lente').forEach(button => {
        button.addEventListener('click', () => {
            const id = button.dataset.id;
            // Corrección: Tu HTML usa 'item_cuadricula', no 'tr'
            const item = button.closest('.item_cuadricula'); 

            Swal.fire({
                title: '¿Estás segura/o?',
                text: "¡Esta acción no se puede deshacer!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sí, borrar'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/delete_lente/${id}`, {
                        method: 'DELETE'
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            item.remove(); // Quitar el item del DOM
                            Swal.fire('Eliminado', 'El modelo fue eliminado.', 'success');
                        }
                    });
                }
            });
        });
    });

    // --- NUEVA LÓGICA PARA ORDENAR ---
    const container = document.getElementById('sortable-models-container');
    if (container) {
        new Sortable(container, {
            animation: 150,
            handle: '.mover', // Usar el botón "Mover" como manija
            ghostClass: 'sortable-ghost', // Clase CSS para el fantasma
            filter: '.agregar_item', // No permitir mover el botón "+"
            preventOnFilter: true, // Necesario para que 'filter' funcione
            
            // Función que se llama al soltar el item
            onEnd: function (evt) {
                // Obtener todos los items en el nuevo orden
                const items = container.querySelectorAll('.item_cuadricula:not(.agregar_item)');
                
                // 1. Crear un array con los model_id en el nuevo orden
                const newOrderModelIds = Array.from(items).map(item => item.dataset.modelId);

                // 2. Enviar este array al backend
                fetch('/admin/update_order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model_ids: newOrderModelIds
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        console.log('Orden global actualizado');
                        // Aquí podrías mostrar una notificación "toast" de éxito si quisieras
                    } else {
                        console.error('Error al actualizar orden:', data.error);
                        alert('Error al guardar el nuevo orden.');
                    }
                })
                .catch(err => {
                    console.error('Error de red:', err);
                    alert('Error de red al guardar el orden.');
                });
            }
        });
    }
</script>
{% endblock %}