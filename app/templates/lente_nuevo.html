{% extends 'layout.html' %}
{% block content %}
<div class="container my-4">
  <h2>Agregar Modelo AR</h2>

  <form method="POST" enctype="multipart/form-data">
    <!-- Selector de producto -->
    <div class="mb-3">
      <label class="form-label">Producto</label>
      <select name="product_id" id="productSelect" required>
        <option value="" selected disabled>Seleccioná un producto…</option>
        {# productos_disponibles: iterable de (product_id, product_model, desc_name) #}
        {% for pid, pmodel, dname in productos_disponibles %}
          <option value="{{ pid }}" data-pmodel="{{ pmodel|e }}" data-dname="{{ dname|e }}">
            {{ pmodel }} — {{ dname }} (ID {{ pid }})
          </option>
        {% endfor %}
      </select>
      <div class="form-text">Sólo aparecen productos que aún no tienen modelo AR asociado.</div>
    </div>

    <!-- Visibilidad -->
    <div class="form-check mb-3">
      <input class="form-check-input" type="checkbox" name="visible" id="visibleCheck" checked>
      <label class="form-check-label" for="visibleCheck">Visible</label>
    </div>

    <!-- Datos simples del modelo AR -->
     <div class="mb-3">
      <label class="form-label">Nombre del modelo AR</label>
      <input type="text" name="name" id="arName" class="form-control">
      <div class="form-text">Por defecto: <code>Producto.model</code>.</div>
    </div>
    <div class="mb-3">
      <label class="form-label">Descripción del modelo AR</label>
      <input type="text" name="description" id="arDescription" class="form-control"
             placeholder="Se completa con el nombre del producto y su descripción, luego podés editarlo.">
      <div class="form-text">Por defecto: <code>ProductDescription.name</code>.</div>
    </div>

    <div class="d-flex gap-2">
      <button type="submit" class="btn btn-success">Crear</button>
      <a href="{{ url_for('main.home_admin') }}" class="btn btn-secondary">Cancelar</a>
    </div>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const selectEl = document.getElementById('productSelect');
  const descEl   = document.getElementById('arDescription');
  const nameEl   = document.getElementById('arName');

  // Inicializa Tom Select
  const ts = new TomSelect('#productSelect', {
    create: false,
    allowEmptyOption: true,
    maxOptions: 5000,
    placeholder: 'Seleccioná un producto…',
    render: {
      option: (data, escape) => `<div>${escape(data.text)}</div>`
    }
  });

  // Completar campos cuando cambia la selección (incluye búsquedas)
  ts.on('change', (value) => {
    if (!value) return;
    const opt = selectEl.querySelector(`option[value="${CSS.escape(value)}"]`);
    if (!opt) return;

    const pmodel = opt.getAttribute('data-pmodel') || '';
    const dname  = opt.getAttribute('data-dname')  || '';

    // antes solo recargaba si estaban vacíos, ahora siempre q se cambie el select
    //if (!nameEl.value?.trim()) nameEl.value = pmodel;
    //if (!descEl.value?.trim()) descEl.value = dname;
    nameEl.value = pmodel;
    descEl.value = dname;
  });

  // Si ya hay un valor precargado (ej. back/validación), dispara el fill
  if (selectEl.value) ts.setValue(selectEl.value, true);
});
</script>


{% endblock %}
