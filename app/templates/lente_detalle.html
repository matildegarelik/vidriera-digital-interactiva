{% extends 'layout.html' %}
{% block css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/editar_producto.css') }}">
{% endblock %}

{% block content %}
<form 
  method="POST" 
  enctype="multipart/form-data"
  action="{{ url_for('main.editar_lente', lente_id=ar_model.model_id) }}"
>
<input type="hidden" name="from_page" value="detalle">
  <div class="container_general">
    <div class="container_dentro">
      <div class="barra_superior">
        <h3>Editar producto</h3>
        <a href="{{ url_for('main.home_admin') }}" class="btn btn-secondary">X</a>
      </div>
      <div class="contenido">
        <div class="contenido_izquierda">
          <div class="titulo_izquierda">
            <h4>Imagen</h4>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" name="visible" id="visibleCheck"
                    {% if ar_model.visible %}checked{% endif %}>
              <label class="form-check-label" for="visibleCheck">Visible</label>
            </div>
          </div>
          <div class="imagen_costado">
            {% if ar_model.path_to_img_front %}
                <img src="/{{ ar_model.path_to_img_front }}" alt="Frente" class="img-fluid">
              {% else %}
                <span class="text-muted">Sin archivo</span>
              {% endif %}
          </div>
          <div class="botones_izquierda">
            <button class="boton_izq">Añadir</button>
            <button class="boton_izq">Cambiar</button>
            <a href="{{ url_for('main.lente_modelo', lente_id=ar_model.model_id) }}" class="boton_izq">Cambiar/agregar modelo</a>
            <button class="boton_izq">Eliminar imagen</button>
          </div>

        </div>
        <div class="contenido_derecha">
          <h4>Características</h4>
          <div class="mb-3">
            <label class="form-label">Nombre</label>
            <input type="text" name="name" class="form-control" value="{{ ar_model.name or '' }}">
          </div>

          <div class="mb-3">
            <label class="form-label">Precio</label>
            <input type="number" name="price" class="form-control"
                  value="{{ ar_model.product.price or '' }}" step="0.01" min="0">
          </div>

          <div class="mb-3 descripcion-container">
            <label class="form-label">Descripción</label>
            <textarea name="description" class="form-control descripcion-textarea">{{ ar_model.description or '' }}</textarea>
          </div>
          <div class="d-flex gap-2">
            <div class="botones_derecha">
              <a href="{{ url_for('main.home_admin') }}" class="btn btn-secondary">Cancelar</a>
              <button type="submit" class="btn btn-primary">Guardar cambios</button>
          
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</form>

<script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>


<script>
  // Toggle visible
  document.getElementById('btnToggle')?.addEventListener('click', async (e) => {
    e.preventDefault();
    const resp = await fetch('{{ url_for("main.toggle_visible", lente_id=ar_model.model_id) }}', { method: 'POST' });
    if (resp.ok) location.reload();
  });

  // Delete
  document.getElementById('btnDelete')?.addEventListener('click', async (e) => {
    e.preventDefault();
    Swal.fire({
      title: "¿Estás seguro?",
      text: "Esta acción eliminará el modelo AR de forma permanente.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#d33",
      cancelButtonColor: "#3085d6",
      confirmButtonText: "Sí, eliminar",
      cancelButtonText: "Cancelar",
      reverseButtons: true,
    }).then(async (result) => {
      if (result.isConfirmed) {
        const resp = await fetch('{{ url_for("main.delete_lente", lente_id=ar_model.model_id) }}', { method: 'DELETE' });
        if (resp.ok) {
          Swal.fire({
            title: "Eliminado",
            text: "El modelo AR se eliminó correctamente.",
            icon: "success",
            timer: 1500,
            showConfirmButton: false
          });
          setTimeout(() => {
            window.location = '{{ url_for("main.home_admin") }}';
          }, 1500);
        } else {
          Swal.fire("Error", "No se pudo eliminar el modelo.", "error");
        }
      }
    });
  });
</script>

<script>
(() => {
  const btn   = document.getElementById('btnPolarizar');
  const ta    = document.getElementById('textareaPolarization');
  if (!btn || !ta) return;

  btn.addEventListener('click', async (e) => {
    e.preventDefault();
    if (btn.disabled) return;

    const modelId = btn.dataset.modelId;
    const url = `{{ url_for('main.api_polarizar', model_id=0) }}`.replace('/0', `/${modelId}`);

    const originalText = btn.textContent;
    btn.textContent = 'Procesando...';
    btn.disabled = true;

    try {
      const resp = await fetch(url, { method: 'GET' });
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      const data = await resp.json();

      // Si tu endpoint devuelve un objeto, lo volcamos formateado
      ta.value = JSON.stringify(data, null, 2);
    } catch (err) {
      console.error(err);
      alert('No se pudo completar desde la imagen aplanada.');
    } finally {
      btn.textContent = originalText;
      // Rehabilitamos el botón solo si sigue existiendo la imagen aplanada
      const hasFrontFlattened = {{ 'true' if ar_model.path_to_img_front_flattened else 'false' }};
      btn.disabled = !hasFrontFlattened;
    }
  });
})();

function confirmarPolarizado(e, el) {
  e.preventDefault(); 

  Swal.fire({
    title: "¿Seguro?",
    text: "Aún no cargaste la información de polarizado. Es recomendable completarla y guardarla antes.",
    icon: "warning",
    showCancelButton: true,
    confirmButtonText: "Sí, continuar",
    cancelButtonText: "No, volver",
    reverseButtons: true,
  }).then((result) => {
    if (result.isConfirmed) {
      window.location.href = el.href;
    }
  });

  return false;
}
</script>

{% endblock %}
